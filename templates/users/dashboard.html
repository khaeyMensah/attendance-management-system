{% extends "base.html" %}

{% block title %}Dashboard - ClassMark{% endblock title %}

{% block stylesheet %}
<style>
  .dashboard-shell {
    display: grid;
    grid-template-columns: 280px minmax(0, 1fr);
    align-items: stretch;
    min-height: 0;
  }
  .dashboard-sidebar {
    width: 280px;
    transition: width 0.2s ease;
  }
  .dashboard-sidebar nav {
    height: 100%;
    border-radius: 0;
  }
  .sidebar-link {
    position: relative;
  }
  .profile-menu {
    transform-origin: top right;
  }

  body.sidebar-collapsed .dashboard-shell {
    grid-template-columns: 86px minmax(0, 1fr);
  }
  body.sidebar-collapsed .dashboard-sidebar {
    width: 86px;
  }
  body.sidebar-collapsed .sidebar-link {
    justify-content: center;
    padding-left: 0.625rem;
    padding-right: 0.625rem;
  }
  body.sidebar-collapsed .sidebar-label,
  body.sidebar-collapsed .sidebar-title {
    display: none;
  }
  body.sidebar-collapsed .sidebar-link:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    left: calc(100% + 10px);
    top: 50%;
    transform: translateY(-50%);
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    background: #0f172a;
    color: #fff;
    font-size: 0.75rem;
    line-height: 1rem;
    white-space: nowrap;
    pointer-events: none;
    box-shadow: 0 8px 20px rgba(15, 23, 42, 0.18);
    z-index: 20;
  }
  body.sidebar-collapsed #sidebar-toggle .line-1 {
    transform: translateY(5px) rotate(45deg);
  }
  body.sidebar-collapsed #sidebar-toggle .line-2 {
    opacity: 0;
  }
  body.sidebar-collapsed #sidebar-toggle .line-3 {
    transform: translateY(-5px) rotate(-45deg);
  }
  #sidebar-toggle .burger-line {
    transition: transform 0.2s ease, opacity 0.2s ease;
    transform-origin: center;
  }

  @media (max-width: 767px) {
    .dashboard-shell {
      grid-template-columns: 1fr;
    }
    .dashboard-sidebar {
      width: 100%;
    }
    body.sidebar-collapsed .dashboard-shell {
      grid-template-columns: 1fr;
    }
    body.sidebar-collapsed .dashboard-sidebar {
      width: 100%;
    }
  }
</style>
{% endblock stylesheet %}

{% block body %}
<div class="min-h-screen bg-slate-100 text-slate-900 flex flex-col">
  <header class="bg-slate-800 text-white border-b border-slate-700">
    <div class="mx-auto max-w-full px-4 sm:px-6 lg:px-5 h-16 flex items-center justify-between gap-5">
      <div class="inline-flex items-center gap-2">
        <button
          id="sidebar-toggle"
          aria-pressed="false"
          class="inline-flex items-center justify-center w-10 h-10 p-0 text-slate-100 border-slate-600 rounded-full hover:bg-slate-700"
          title="Collapse sidebar"
          aria-label="Collapse sidebar"
          type="button"
        >
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
            <path class="burger-line line-1" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7h16"/>
            <path class="burger-line line-2" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12h16"/>
            <path class="burger-line line-3" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 17h16"/>
          </svg>
        </button>
        <a href="{% url 'home' %}" class="inline-flex items-center gap-1">
          <span class="inline-flex items-center justify-center w-8 h-8 text-sm font-semibold text-white bg-indigo-600 rounded-xl">CM</span>
          <span class="text-lg font-semibold">ClassMark</span>
        </a>
      </div>

      <form id="dashboard-search-form" class="flex items-center w-full max-w-md" role="search" autocomplete="off">
        <input
          id="dashboard-search"
          type="search"
          name="q"
          class="w-full rounded-l-full border border-slate-300 px-3 py-2 text-slate-900 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          placeholder="Search"
          aria-label="Search pages"
          list="dashboard-pages"
        />
        <datalist id="dashboard-pages">
          <option value="Dashboard"></option>
          <option value="Scan QR Code"></option>
          <option value="My Attendance"></option>
          <option value="Courses"></option>
          <option value="Sessions"></option>
          <option value="Reports"></option>
          <option value="Profile"></option>
          <option value="Logout"></option>
        </datalist>
        <button type="submit" class="inline-flex items-center justify-center h-[42px] w-12 rounded-r-full bg-indigo-600 hover:bg-indigo-700" aria-label="Search">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z"/>
          </svg>
        </button>
      </form>

      <div class="relative">
        <button
          id="profile-toggle"
          class="inline-flex items-center justify-center h-10 w-10 rounded-full bg-slate-600 hover:bg-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-400"
          title="{{ request.user.full_name|default:request.user.username }}"
          aria-haspopup="true"
          aria-expanded="false"
          aria-label="Open profile menu"
          type="button"
        >
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.12 17.8A10.94 10.94 0 0 1 12 15c2.21 0 4.27.66 5.88 1.8M15 9a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
          </svg>
        </button>
        <div id="profile-menu" class="profile-menu hidden absolute right-0 mt-2 w-56 rounded-lg bg-white text-slate-800 border border-slate-200 shadow-lg z-30">
          <div class="px-4 py-3 border-b border-slate-100">
            <p class="text-sm font-medium">{{ request.user.full_name|default:request.user.username }}</p>
            <p class="text-xs text-slate-500">{{ request.user.email }}</p>
          </div>

          {% if request.user.role == 'student' %}
          <a href="{% url 'users:student_dashboard' %}" class="flex items-center gap-2 px-4 py-2.5 text-sm hover:bg-slate-50">
          {% elif request.user.role == 'lecturer' %}
          <a href="{% url 'users:lecturer_dashboard' %}" class="flex items-center gap-2 px-4 py-2.5 text-sm hover:bg-slate-50">
          {% else %}
          <a href="{% url 'home' %}" class="flex items-center gap-2 px-4 py-2.5 text-sm hover:bg-slate-50">
          {% endif %}
            <svg class="h-4 w-4 text-slate-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.12 17.8A10.94 10.94 0 0 1 12 15c2.21 0 4.27.66 5.88 1.8M15 9a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
            </svg>
            <span>Profile</span>
          </a>
          <a href="{% url 'users:password_change' %}" class="flex items-center gap-2 px-4 py-2.5 text-sm hover:bg-slate-50">
            <svg class="h-4 w-4 text-slate-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2h-1V9a5 5 0 0 0-10 0v2H6a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2zm3-10V9a3 3 0 0 1 6 0v2H9z"/>
            </svg>
            <span>Settings</span>
          </a>
          <a href="{% url 'users:logout' %}" class="flex items-center gap-2 px-4 py-2.5 text-sm text-rose-700 hover:bg-rose-50">
            <svg class="h-4 w-4 text-rose-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 17l5-5m0 0l-5-5m5 5H9m-4 8h4V4H5"/>
            </svg>
            <span>Logout</span>
          </a>
        </div>
      </div>
    </div>
  </header>

  <div class="flex-1 mx-auto max-w-full w-full px-4 sm:px-6 lg:px-0 py-0 dashboard-shell">
    <aside class="dashboard-sidebar shrink-0">
      <nav class="bg-slate-800 text-slate-100 p-3 shadow">
        {% comment %} <p class="sidebar-title px-5 py-2 text-xs uppercase tracking-wider text-slate-400">Navigation</p> {% endcomment %}

        {% if request.user.role == 'student' %}
        <a class="sidebar-link flex items-center gap-4 rounded-lg px-5 py-2 bg-slate-700 mb-1" href="{% url 'users:student_dashboard' %}" data-tooltip="Dashboard">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 13h8V3H3v10zm10 8h8V3h-8v18zM3 21h8v-6H3v6z"/>
          </svg>
          <span class="sidebar-label">Dashboard</span>
        </a>

        <a class="sidebar-link flex items-center gap-4 rounded-lg px-5 py-2 hover:bg-slate-700 mb-1" href="{% url 'users:student_dashboard' %}" data-tooltip="Scan QR Code">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7V4h3M20 7V4h-3M4 17v3h3M20 17v3h-3M9 9h6v6H9V9z"/>
          </svg>
          <span class="sidebar-label">Scan QR Code</span>
        </a>

        <a class="sidebar-link flex items-center gap-4 rounded-lg px-5 py-2 hover:bg-slate-700 mb-1" href="{% url 'users:student_dashboard' %}#attendance" data-tooltip="My Attendance">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M4 6h16M4 12h4m-4 6h16"/>
          </svg>
          <span class="sidebar-label">My Attendance</span>
        </a>

        <a class="sidebar-link flex items-center gap-4 rounded-lg px-5 py-2 hover:bg-slate-700 mb-1" href="{% url 'users:password_change' %}" data-tooltip="Profile">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A10.97 10.97 0 0 1 12 15c2.21 0 4.268.71 5.879 1.904M15 9a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
          </svg>
          <span class="sidebar-label">Profile</span>
        </a>

        {% elif request.user.role == 'lecturer' %}
        <a class="sidebar-link flex items-center gap-4 rounded-lg px-5 py-2 bg-slate-700 mb-1" href="{% url 'users:lecturer_dashboard' %}" data-tooltip="Dashboard">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5h16v4H4V5zm0 6h10v8H4v-8zm12 0h4v8h-4v-8z"/>
          </svg>
          <span class="sidebar-label">Dashboard</span>
        </a>

        <a class="sidebar-link flex items-center gap-4 rounded-lg px-5 py-2 hover:bg-slate-700 mb-1" href="{% url 'users:lecturer_dashboard' %}#courses" data-tooltip="Courses">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6l4 2M4 7h16M4 17h16"/>
          </svg>
          <span class="sidebar-label">Courses</span>
        </a>

        <a class="sidebar-link flex items-center gap-4 rounded-lg px-5 py-2 hover:bg-slate-700 mb-1" href="{% url 'users:lecturer_dashboard' %}#sessions" data-tooltip="Sessions">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h8M8 12h8M8 17h8"/>
          </svg>
          <span class="sidebar-label">Sessions</span>
        </a>

        <a class="sidebar-link flex items-center gap-4 rounded-lg px-5 py-2 hover:bg-slate-700 mb-1" href="{% url 'users:lecturer_dashboard' %}#attendance-reports" data-tooltip="Attendance Reports">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3v18h18M8 13l3-3 2 2 4-4"/>
          </svg>
          <span class="sidebar-label">Attendance Reports</span>
        </a>

        <a class="sidebar-link flex items-center gap-4 rounded-lg px-5 py-2 hover:bg-slate-700 mb-1" href="{% url 'users:password_change' %}" data-tooltip="Profile">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A10.97 10.97 0 0 1 12 15c2.21 0 4.268.71 5.879 1.904M15 9a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
          </svg>
          <span class="sidebar-label">Profile</span>
        </a>

        {% else %}
        <a class="sidebar-link flex items-center gap-4 rounded-lg px-5 py-2 bg-slate-700 mb-1" href="{% url 'admin:index' %}" data-tooltip="Admin Dashboard">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h18v6H3V3zm0 9h18v9H3v-9z"/>
          </svg>
          <span class="sidebar-label">Dashboard</span>
        </a>

        <a class="sidebar-link flex items-center gap-4 rounded-lg px-5 py-2 hover:bg-slate-700 mb-1" href="{% url 'admin:index' %}" data-tooltip="Users">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11a4 4 0 1 0-8 0 4 4 0 0 0 8 0zM4 21a8 8 0 0 1 16 0"/>
          </svg>
          <span class="sidebar-label">Manage Users</span>
        </a>

        <a class="sidebar-link flex items-center gap-4 rounded-lg px-5 py-2 hover:bg-slate-700 mb-1" href="{% url 'admin:index' %}" data-tooltip="Courses">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6l4 2M4 7h16M4 17h16"/>
          </svg>
          <span class="sidebar-label">Manage Courses</span>
        </a>

        <a class="sidebar-link flex items-center gap-4 rounded-lg px-5 py-2 hover:bg-slate-700 mb-1" href="{% url 'admin:index' %}" data-tooltip="Attendance Logs">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M4 6h16M4 12h4m-4 6h16"/>
          </svg>
          <span class="sidebar-label">Attendance Logs</span>
        </a>
        {% endif %}

        <a class="sidebar-link flex items-center gap-4 rounded-lg px-5 py-2 hover:bg-slate-700 mb-1" href="{% url 'home' %}" data-tooltip="Home">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 11.5L12 4l9 7.5M5 10v9h14v-9" />
          </svg>
          <span class="sidebar-label">Home</span>
        </a>
        
        <a class="sidebar-link flex items-center gap-4 rounded-lg px-5 py-2 hover:bg-slate-700 mb-1" href="{% url 'users:logout' %}" data-tooltip="Logout">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 17l5-5m0 0l-5-5m5 5H9m-4 8h4V4H5"/>
          </svg>
          <span class="sidebar-label">Logout</span>
        </a>
      </nav>
    </aside>

    <section class="flex-1 bg-white shadow p-6">
      {% block content %}
      {% if request.user.role == 'student' %}
      <h1 class="text-2xl font-semibold">Student Dashboard</h1>
      <p class="mt-2 text-slate-600">Welcome, {{ request.user.full_name|default:request.user.username }}.</p>

      <div id="attendance" class="mt-6 grid gap-4 sm:grid-cols-3">
        <div class="p-4 bg-white border rounded-lg">
          <div class="text-sm text-slate-500">Total Classes</div>
          <div class="text-2xl font-bold">-</div>
        </div>
        <div class="p-4 bg-white border rounded-lg">
          <div class="text-sm text-slate-500">Present</div>
          <div class="text-2xl font-bold text-green-600">-</div>
        </div>
        <div class="p-4 bg-white border rounded-lg">
          <div class="text-sm text-slate-500">Absent</div>
          <div class="text-2xl font-bold text-red-600">-</div>
        </div>
      </div>

      <div id="scan-qr" class="mt-6">
        <a href="{% url 'users:student_dashboard' %}" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Scan QR Code</a>
      </div>

      {% elif request.user.role == 'lecturer' %}
      <h1 class="text-2xl font-semibold">Lecturer Dashboard</h1>
      <p class="mt-2 text-slate-600">Welcome, {{ request.user.full_name|default:request.user.username }}.</p>

      <div class="mt-6 grid gap-4 sm:grid-cols-3">
        <div class="p-4 bg-white border rounded-lg">
          <div class="text-sm text-slate-500">Total Courses</div>
          <div class="text-2xl font-bold">-</div>
        </div>
        <div class="p-4 bg-white border rounded-lg">
          <div class="text-sm text-slate-500">Today's Sessions</div>
          <div class="text-2xl font-bold">-</div>
        </div>
        <div class="p-4 bg-white border rounded-lg">
          <div class="text-sm text-slate-500">Attendance Rate</div>
          <div class="text-2xl font-bold text-green-600">-</div>
        </div>
      </div>

      <div id="sessions" class="mt-6">
        <a href="{% url 'users:lecturer_dashboard' %}" class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Create Session / Generate QR Code</a>
      </div>

      <div id="attendance-reports" class="mt-8">
        <h2 class="text-lg font-semibold">Recent Attendance Activity</h2>
        <div class="mt-3 overflow-x-auto border rounded-lg">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 text-slate-600">
              <tr>
                <th class="px-4 py-3 text-left">Course</th>
                <th class="px-4 py-3 text-left">Session</th>
                <th class="px-4 py-3 text-left">Present</th>
                <th class="px-4 py-3 text-left">Absent</th>
                <th class="px-4 py-3 text-left">Date</th>
              </tr>
            </thead>
            <tbody>
              <tr class="border-t">
                <td class="px-4 py-3 text-slate-500" colspan="5">No recent activity yet.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      {% else %}
      <h1 class="text-2xl font-semibold">Admin Dashboard</h1>
      <p class="mt-2 text-slate-600">System overview and management tools.</p>

      <div class="mt-6 grid gap-4 sm:grid-cols-4">
        <div class="p-4 bg-white border rounded-lg">
          <div class="text-sm text-slate-500">Total Users</div>
          <div class="text-2xl font-bold">-</div>
        </div>
        <div class="p-4 bg-white border rounded-lg">
          <div class="text-sm text-slate-500">Students</div>
          <div class="text-2xl font-bold">-</div>
        </div>
        <div class="p-4 bg-white border rounded-lg">
          <div class="text-sm text-slate-500">Lecturers</div>
          <div class="text-2xl font-bold">-</div>
        </div>
        <div class="p-4 bg-white border rounded-lg">
          <div class="text-sm text-slate-500">Attendance Logs</div>
          <div class="text-2xl font-bold">-</div>
        </div>
      </div>

      <div class="mt-6">
        <a href="{% url 'admin:index' %}" class="inline-flex items-center px-4 py-2 bg-slate-900 text-white rounded-md hover:bg-black">Open Django Admin</a>
      </div>
      {% endif %}
      {% endblock content %}
    </section>
  </div>

  <footer class="bg-white border-t">
    <div class="flex flex-col items-center justify-between max-w-full gap-4 px-4 py-6 mx-auto sm:px-6 lg:px-8 sm:flex-row">
      <p class="text-sm text-slate-600">Loading - ClassMark</p>
      <p class="text-sm text-slate-500">(c) {% now "Y" %} Khaey</p>
    </div>
  </footer>
</div>

<script>
  (function () {
    const profileToggle = document.getElementById("profile-toggle");
    const profileMenu = document.getElementById("profile-menu");
    if (!profileToggle || !profileMenu) return;

    const closeMenu = function () {
      profileMenu.classList.add("hidden");
      profileToggle.setAttribute("aria-expanded", "false");
    };

    profileToggle.addEventListener("click", function (event) {
      event.stopPropagation();
      const isHidden = profileMenu.classList.toggle("hidden");
      profileToggle.setAttribute("aria-expanded", isHidden ? "false" : "true");
    });

    document.addEventListener("click", function (event) {
      if (!profileMenu.contains(event.target) && !profileToggle.contains(event.target)) {
        closeMenu();
      }
    });

    document.addEventListener("keydown", function (event) {
      if (event.key === "Escape") closeMenu();
    });
  })();
</script>
{% endblock body %}
